name: Build and Deploy to Azure VM

on:
  push:
    branches:
      - main  # Trigger deployment on push to main (or your desired branch)

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the code
    - name: Checkout code
      uses: actions/checkout@v4

    # Step 2: Compress the code
    - name: Compress project files
      run: |
        zip -r acd.zip ./*
        ls -la

    # Step 3: Save the SSH private key to a file
    - name: Add SSH Key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ssh_key.pem
        chmod 600 ssh_key.pem

    # Step 4: Copy the compressed file to the Azure VM using SCP
    - name: Copy compressed source code to Azure VM
      run: |
        scp -o StrictHostKeyChecking=no -i ssh_key.pem acd.zip ${{ vars.AZURE_VM_USERNAME }}@${{ vars.AZURE_VM_IP }}:/home/${{ vars.AZURE_VM_USERNAME }}/

    # - name: SSH to Azure VM
    #   run: |
    #     ssh -o StrictHostKeyChecking=no -i ssh_key.pem ${{ vars.AZURE_VM_USERNAME }}@${{ vars.AZURE_VM_IP }}


    # Step 5: SSH into the Azure VM and deploy the Docker container
    - name: SSH into Azure VM and deploy container
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ vars.AZURE_VM_IP }}
        username: ${{ vars.AZURE_VM_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # Navigate to the user's home directory
          cd /home/${{ vars.AZURE_VM_USERNAME }}

          # Verify the acd.zip file exists
          if [ ! -f "acd.zip" ]; then
            echo "File acd.zip was not copied successfully."
            exit 1
          fi

          # Remove the old app directory if it exists
          rm -rf app

          # Unzip into a new directory
          unzip -o acd.zip -d app

          # Verify that the unzipped files are present
          if [ -d "app" ]; then
            echo "Unzip successful. Listing contents of 'app' directory:"
            ls -la app
          else
            echo "Unzip failed or 'app' directory does not exist."
            exit 1
          fi

          # Navigate to the Docker directory
          cd app/docker/
          
          # Build the Docker image locally with no cache to ensure it's up-to-date
          docker build --no-cache -t nextjs-app .

          # Stop and remove any existing container
          docker stop nextjs-container || true
          docker rm nextjs-container || true
          
          # Run the Docker container
          docker run -d --name nextjs-container -p 3000:3000 nextjs-app

          echo "Docker container deployed successfully. Access your application at http://${{ vars.AZURE_VM_IP }}:3000"

    # Step 6: Clean up by removing the SSH key file
    - name: Clean up
      run: |
        rm ssh_key.pem
